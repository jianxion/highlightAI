AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: HighlightAI - Authentication and Video Upload Module
Globals:
  Function:
    Runtime: python3.11
    Timeout: 30
    MemorySize: 256
Resources:
  FFmpegLayer:
    Type: AWS::Lambda::LayerVersion
    Properties:
      LayerName: highlightai-ffmpeg
      Description: FFmpeg binary for video processing
      Content:
        S3Bucket:
          Fn::Sub: highlightai-layers-${AWS::AccountId}
        S3Key: ffmpeg-layer.zip
      CompatibleRuntimes:
      - python3.11
  RawVideosBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName:
        Fn::Sub: highlightai-raw-videos-${AWS::AccountId}
      CorsConfiguration:
        CorsRules:
        - AllowedOrigins:
          - '*'
          AllowedMethods:
          - PUT
          - POST
          - GET
          AllowedHeaders:
          - '*'
          MaxAge: 3000
      NotificationConfiguration:
        QueueConfigurations:
        - Event: s3:ObjectCreated:*
          Queue:
            Fn::GetAtt:
            - UploadQueue
            - Arn
          Filter:
            S3Key:
              Rules:
              - Name: prefix
                Value: videos/
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      LifecycleConfiguration:
        Rules:
        - Id: DeleteOldRawVideos
          Status: Enabled
          ExpirationInDays: 7
  EditedVideosBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName:
        Fn::Sub: highlightai-edited-videos-${AWS::AccountId}
      CorsConfiguration:
        CorsRules:
        - AllowedOrigins:
          - '*'
          AllowedMethods:
          - PUT
          - POST
          - GET
          AllowedHeaders:
          - '*'
          MaxAge: 3000
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      LifecycleConfiguration:
        Rules:
        - Id: DeleteOldEditedVideos
          Status: Enabled
          ExpirationInDays: 7
  UploadQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: highlightai-upload-queue
      VisibilityTimeout: 660
      MessageRetentionPeriod: 86400
      RedrivePolicy:
        deadLetterTargetArn:
          Fn::GetAtt:
          - UploadDLQ
          - Arn
        maxReceiveCount: 3
  UploadDLQ:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: highlightai-upload-dlq
      MessageRetentionPeriod: 1209600
  UploadQueuePolicy:
    Type: AWS::SQS::QueuePolicy
    Properties:
      Queues:
      - Ref: UploadQueue
      PolicyDocument:
        Statement:
        - Effect: Allow
          Principal:
            Service: s3.amazonaws.com
          Action:
          - SQS:SendMessage
          Resource:
            Fn::GetAtt:
            - UploadQueue
            - Arn
          Condition:
            StringLike:
              aws:SourceArn:
                Fn::Sub: arn:aws:s3:::highlightai-raw-videos-${AWS::AccountId}
  VideosTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: highlightai-videos
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
      - AttributeName: videoId
        AttributeType: S
      - AttributeName: userId
        AttributeType: S
      - AttributeName: createdAt
        AttributeType: N
      KeySchema:
      - AttributeName: videoId
        KeyType: HASH
      GlobalSecondaryIndexes:
      - IndexName: UserVideosIndex
        KeySchema:
        - AttributeName: userId
          KeyType: HASH
        - AttributeName: createdAt
          KeyType: RANGE
        Projection:
          ProjectionType: ALL
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES
  UserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: highlightai-users
      UsernameAttributes:
      - email
      AutoVerifiedAttributes:
      - email
      EmailConfiguration:
        EmailSendingAccount: COGNITO_DEFAULT
      Schema:
      - Name: email
        Required: true
        Mutable: false
      - Name: name
        Required: false
        Mutable: true
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireUppercase: true
          RequireLowercase: true
          RequireNumbers: true
          RequireSymbols: false
  UserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      ClientName: highlightai-client
      UserPoolId:
        Ref: UserPool
      ExplicitAuthFlows:
      - ALLOW_USER_PASSWORD_AUTH
      - ALLOW_REFRESH_TOKEN_AUTH
      GenerateSecret: false
      TokenValidityUnits:
        AccessToken: hours
        IdToken: hours
        RefreshToken: days
      AccessTokenValidity: 1
      IdTokenValidity: 1
      RefreshTokenValidity: 30
  ApiGateway:
    Type: AWS::Serverless::Api
    Properties:
      Name: highlightai-api
      StageName: dev
      Cors:
        AllowOrigin: '''*'''
        AllowHeaders: '''Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'''
        AllowMethods: '''GET,POST,PUT,DELETE,OPTIONS'''
        AllowCredentials: false
      Auth:
        DefaultAuthorizer: CognitoAuthorizer
        Authorizers:
          CognitoAuthorizer:
            UserPoolArn:
              Fn::GetAtt:
              - UserPool
              - Arn
            Identity:
              Header: Authorization
      GatewayResponses:
        DEFAULT_4XX:
          ResponseParameters:
            Headers:
              Access-Control-Allow-Origin: '''*'''
              Access-Control-Allow-Headers: '''Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'''
        DEFAULT_5XX:
          ResponseParameters:
            Headers:
              Access-Control-Allow-Origin: '''*'''
              Access-Control-Allow-Headers: '''Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'''
  SignupFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: highlightai-signup
      CodeUri: SignupFunction
      Handler: signup.lambda_handler
      Environment:
        Variables:
          CLIENT_ID:
            Ref: UserPoolClient
      Policies:
      - Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - cognito-idp:SignUp
          Resource:
            Fn::GetAtt:
            - UserPool
            - Arn
      Events:
        SignupApi:
          Type: Api
          Properties:
            RestApiId:
              Ref: ApiGateway
            Path: /auth/signup
            Method: POST
            Auth:
              Authorizer: NONE
    Metadata:
      SamResourceId: SignupFunction
  SigninFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: highlightai-signin
      CodeUri: SigninFunction
      Handler: signin.lambda_handler
      Environment:
        Variables:
          CLIENT_ID:
            Ref: UserPoolClient
      Policies:
      - Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - cognito-idp:InitiateAuth
          Resource:
            Fn::GetAtt:
            - UserPool
            - Arn
      Events:
        SigninApi:
          Type: Api
          Properties:
            RestApiId:
              Ref: ApiGateway
            Path: /auth/signin
            Method: POST
            Auth:
              Authorizer: NONE
    Metadata:
      SamResourceId: SigninFunction
  PresignedUrlFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: highlightai-presigned-url
      CodeUri: PresignedUrlFunction
      Handler: handler.lambda_handler
      Environment:
        Variables:
          RAW_VIDEOS_BUCKET:
            Ref: RawVideosBucket
          VIDEOS_TABLE:
            Ref: VideosTable
      Policies:
      - Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - s3:PutObject
          - s3:PutObjectAcl
          Resource:
            Fn::Sub: ${RawVideosBucket.Arn}/videos/*
        - Effect: Allow
          Action:
          - dynamodb:PutItem
          Resource:
            Fn::GetAtt:
            - VideosTable
            - Arn
      Events:
        GetPresignedUrlApi:
          Type: Api
          Properties:
            RestApiId:
              Ref: ApiGateway
            Path: /upload/presigned-url
            Method: POST
    Metadata:
      SamResourceId: PresignedUrlFunction
  UploadCompleteFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: highlightai-upload-complete
      CodeUri: UploadCompleteFunction
      Handler: handler.lambda_handler
      Environment:
        Variables:
          VIDEOS_TABLE:
            Ref: VideosTable
      Policies:
      - Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - dynamodb:UpdateItem
          - dynamodb:GetItem
          Resource:
            Fn::GetAtt:
            - VideosTable
            - Arn
        - Effect: Allow
          Action:
          - sqs:ReceiveMessage
          - sqs:DeleteMessage
          - sqs:GetQueueAttributes
          Resource:
            Fn::GetAtt:
            - UploadQueue
            - Arn
      Events:
        SQSEvent:
          Type: SQS
          Properties:
            Queue:
              Fn::GetAtt:
              - UploadQueue
              - Arn
            BatchSize: 10
    Metadata:
      SamResourceId: UploadCompleteFunction
  VideoEditorRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service: lambda.amazonaws.com
          Action: sts:AssumeRole
      ManagedPolicyArns:
      - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
      - PolicyName: VideoEditorPolicy
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - s3:GetObject
            - s3:HeadObject
            Resource:
              Fn::Sub: ${RawVideosBucket.Arn}/videos/*
          - Effect: Allow
            Action:
            - s3:PutObject
            Resource:
              Fn::Sub: ${EditedVideosBucket.Arn}/edited/*
          - Effect: Allow
            Action:
            - dynamodb:UpdateItem
            - dynamodb:GetItem
            Resource:
              Fn::GetAtt:
              - VideosTable
              - Arn
          - Effect: Allow
            Action:
            - transcribe:StartTranscriptionJob
            - transcribe:GetTranscriptionJob
            Resource:
              Fn::Sub: arn:aws:transcribe:${AWS::Region}:${AWS::AccountId}:transcription-job/*
          - Effect: Allow
            Action:
            - sqs:ReceiveMessage
            - sqs:DeleteMessage
            - sqs:GetQueueAttributes
            Resource:
              Fn::GetAtt:
              - UploadQueue
              - Arn
          - Effect: Allow
            Action:
            - rekognition:DetectLabels
            Resource: '*'
          - Effect: Allow
            Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
            Resource:
              Fn::Sub: arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/*
  VideoEditorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: highlightai-video-editor
      CodeUri: VideoEditorFunction
      Handler: handler.lambda_handler
      Runtime: python3.11
      Timeout: 600
      MemorySize: 3008
      Layers:
      - Ref: FFmpegLayer
      Role:
        Fn::GetAtt:
        - VideoEditorRole
        - Arn
      Environment:
        Variables:
          RAW_VIDEOS_BUCKET:
            Ref: RawVideosBucket
          EDITED_VIDEOS_BUCKET:
            Ref: EditedVideosBucket
          VIDEOS_TABLE:
            Ref: VideosTable
          REGION:
            Ref: AWS::Region
      Events:
        SQSEvent:
          Type: SQS
          Properties:
            Queue:
              Fn::GetAtt:
              - UploadQueue
              - Arn
            BatchSize: 1
            MaximumBatchingWindowInSeconds: 5
    Metadata:
      SamResourceId: VideoEditorFunction
Outputs:
  ApiUrl:
    Description: API Gateway endpoint URL
    Value:
      Fn::Sub: https://${ApiGateway}.execute-api.${AWS::Region}.amazonaws.com/dev
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-ApiUrl
  UserPoolId:
    Description: Cognito User Pool ID
    Value:
      Ref: UserPool
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-UserPoolId
  UserPoolClientId:
    Description: Cognito User Pool Client ID
    Value:
      Ref: UserPoolClient
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-UserPoolClientId
  RawVideosBucketName:
    Description: S3 Bucket for raw video uploads
    Value:
      Ref: RawVideosBucket
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-RawVideosBucket
  VideosTableName:
    Description: DynamoDB Table for video metadata
    Value:
      Ref: VideosTable
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-VideosTable
  UploadQueueUrl:
    Description: SQS Queue URL for upload notifications
    Value:
      Ref: UploadQueue
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-UploadQueueUrl
  EditedVideosBucketName:
    Description: S3 Bucket for edited video outputs
    Value:
      Ref: EditedVideosBucket
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-EditedVideosBucket
  VideoEditorFunctionArn:
    Description: ARN of video editor Lambda function
    Value:
      Fn::GetAtt:
      - VideoEditorFunction
      - Arn
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-VideoEditorArn
  VideoEditorRoleArn:
    Description: ARN of video editor IAM role
    Value:
      Fn::GetAtt:
      - VideoEditorRole
      - Arn
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-VideoEditorRole
